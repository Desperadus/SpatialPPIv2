Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

%files
    env/environment.yaml environment.yaml

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    apt-get update
    apt-get install -y --no-install-recommends \
        bzip2 \
        ca-certificates \
        curl \
        git
    rm -rf /var/lib/apt/lists/*

    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest \
      | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba

    export MAMBA_ROOT_PREFIX=/opt/conda
    mkdir -p "${MAMBA_ROOT_PREFIX}"

    micromamba create -y -n SpatialPPIv2 -f environment.yaml
    micromamba clean -a -y

%environment
    export MAMBA_ROOT_PREFIX=/opt/conda
    export MAMBA_EXE=/usr/local/bin/micromamba
    export CONDA_DEFAULT_ENV=SpatialPPIv2
    export PATH=/opt/conda/envs/SpatialPPIv2/bin:/opt/conda/bin:$PATH
    export CUDA_HOME=/usr/local/cuda
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:${LD_LIBRARY_PATH}

%runscript
    if [ "$#" -eq 0 ]; then
        exec /bin/bash
    else
        exec micromamba run -n SpatialPPIv2 "$@"
    fi
